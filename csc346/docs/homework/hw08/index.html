<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link href="https://use.typekit.net/emv3zbo.css" rel="stylesheet" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdn.digital.arizona.edu/lib/az-icons/main/az-icons-styles.css">

<link rel="stylesheet" href="https://cdn.digital.arizona.edu/lib/arizona-bootstrap/main/css/arizona-bootstrap.min.css">
<meta name="description" content="CSC 346 - Homework 8 # In this homework assignment you will deploy The PictureGram App from Homework 6 in AWS with the Elastic Container Service and an Application Load Blancer instead of directly on EC2. We&#39;ll also integrate the image upload system from homework 7 in to the app.
You will need to create an Elastic Container Registry (ECR) repository to hold your docker image, and the build and push the image up.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="Homework 8" />
<meta property="og:description" content="CSC 346 - Homework 8 # In this homework assignment you will deploy The PictureGram App from Homework 6 in AWS with the Elastic Container Service and an Application Load Blancer instead of directly on EC2. We&#39;ll also integrate the image upload system from homework 7 in to the app.
You will need to create an Elastic Container Registry (ECR) repository to hold your docker image, and the build and push the image up." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://portfolio.fischco.org/csc346/docs/homework/hw08/" /><meta property="article:section" content="docs" />



<title>Homework 8 | CSC 346 - Spring 2024</title>
<link rel="manifest" href="/csc346/manifest.json">
<link rel="icon" href="/csc346/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/csc346/book.min.d51bbb52e2488901c7e88b7b51aaa9d45b425ee7b86e262fd6e61ee86f1de386.css" integrity="sha256-1Ru7UuJIiQHH6It7Uaqp1FtCXue4biYv1uYe6G8d44Y=" crossorigin="anonymous">
  <script defer src="/csc346/flexsearch.min.js"></script>
  <script defer src="/csc346/en.search.min.32b22e257e20361f18e3a42943a3adc671ec92b1cac331c46ccbbc1018d0464c.js" integrity="sha256-MrIuJX4gNh8Y46QpQ6OtxnHskrHKwzHEbMu8EBjQRkw=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />

  <div class="bg-red p-3 mb-5" style="position: fixed; top: 0; width: 100%; z-index: 100;">
    <div class="container">
      <div class="row">
        <div class="col-12"><span class="text-uppercase heading-style m-0 text-white">The University of Arizona</span></div>
      </div>
    </div>
  </div>

  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h5 class="book-brand">
  <a class="flex align-center" href="/csc346/"><span>CSC 346 - Spring 2024</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <span>Homework</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/csc346/docs/homework/hw01/" class="">Homework 1</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/csc346/docs/homework/hw02/" class="">Homework 2</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/csc346/docs/homework/hw03/" class="">Homework 3</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/csc346/docs/homework/hw04/" class="">Homework 4</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/csc346/docs/homework/hw05/" class="">Homework 5</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/csc346/docs/homework/hw06/" class="">Homework 6</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/csc346/docs/homework/hw07/" class="">Homework 7</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/csc346/docs/homework/hw08/" class="active">Homework 8</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Examples</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/csc346/docs/examples/ajax-demo/" class="">AJAX Example</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/csc346/docs/examples/picturegram-api/" class="">PictureGram API</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/csc346/docs/examples/http/" class="">Raw HTTP Example</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Exams</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/csc346/docs/exams/exam1-guide/" class="">Exam 1 Study Guide</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/csc346/docs/exams/exam2-guide/" class="">Exam 2 Study Guide</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/csc346/docs/exams/exam3-guide/" class="">Exam 3 Study Guide</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/csc346/docs/exams/notes/" class="">Exam Notes</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  
<div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/csc346/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Homework 8</strong>

  <label for="toc-control">
    
    <img src="/csc346/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#what-to-turn-in">What to turn in</a></li>
    <li><a href="#points">Points</a></li>
    <li><a href="#starting-point">Starting Point</a></li>
    <li><a href="#part-0-update-s3-cloudformation-template-and-function-url">Part 0: Update S3 CloudFormation Template and Function URL</a>
      <ul>
        <li><a href="#cloudformation-console">CloudFormation Console</a></li>
        <li><a href="#update-s3-stack">Update S3 Stack</a></li>
        <li><a href="#lambda-function-url-cors-configuration">Lambda Function URL CORS Configuration</a></li>
      </ul>
    </li>
    <li><a href="#part-1-upload-attached-images">Part 1: Upload Attached Images</a></li>
    <li><a href="#part-2-update-chat-post-with-image-urls">Part 2: Update Chat POST with Image URLs</a></li>
    <li><a href="#part-3-elastic-container-registry">Part 3: Elastic Container Registry</a></li>
    <li><a href="#part-4-build-and-push-your-docker-image">Part 4: Build and Push Your Docker Image</a></li>
    <li><a href="#part-5-aws-certificate-manager">Part 5: AWS Certificate Manager</a></li>
    <li><a href="#part-6-gather-remaining-parameter-values">Part 6: Gather Remaining Parameter Values</a>
      <ul>
        <li><a href="#lab-role-arn">Lab Role ARN</a></li>
        <li><a href="#vpc-id">VPC ID</a></li>
        <li><a href="#vpc-subnet-ids">VPC Subnet IDs</a></li>
      </ul>
    </li>
    <li><a href="#part-7-cloudformation-deployment">Part 7: CloudFormation Deployment</a></li>
    <li><a href="#part-8-re-deploy-your-ecs-service">Part 8: Re-Deploy Your ECS Service</a></li>
    <li><a href="#part-9-automated-testing">Part 9: Automated Testing</a></li>
    <li><a href="#troubleshooting">Troubleshooting</a>
      <ul>
        <li><a href="#cloudformation-stack-deployment-errors">CloudFormation Stack Deployment Errors</a></li>
        <li><a href="#failed-test-results">FAILED Test Results</a></li>
        <li><a href="#docker-issues">Docker Issues</a></li>
        <li><a href="#cors-issue">CORS Issue</a></li>
        <li><a href="#503-service-unavailable">503 Service Unavailable</a></li>
        <li><a href="#javascript-files-never-update">JavaScript Files Never Update</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="csc-346---homework-8">
  CSC 346 - Homework 8
  <a class="anchor" href="#csc-346---homework-8">#</a>
</h1>
<p>In this homework assignment you will deploy The PictureGram App from Homework 6 in AWS with the Elastic Container Service and an Application Load Blancer instead of directly on EC2. We'll also integrate the image upload system from homework 7 in to the app.</p>
<p>You will need to create an Elastic Container Registry (ECR) repository to hold your docker image, and the build and push the image up. Then you will need to import an SSL TLS certificate to use on our Application Load Balancer. Then you'll need to collect a few bits of information to use in deploying the CloudFormation template. Lastly I will have an updated automated test app site for you to use to test your infrastructure deployments.</p>
<h2 id="what-to-turn-in">
  What to turn in
  <a class="anchor" href="#what-to-turn-in">#</a>
</h2>
<p>Turn in a .zip file of a folder containing the following files:</p>
<pre tabindex="0"><code>yournetid-hw08/
        notes.txt
        Dockerfile
        html/
            favicon.ico
            index.html
            js/
                app.js
                picturegramSDK.js
</code></pre><h2 id="points">
  Points
  <a class="anchor" href="#points">#</a>
</h2>
<p>This assignment will be worth 60 points. Turning the assignment in early will earn you an additional 10 points extra credit.</p>
<ul>
<li>Early submission:  April 25th 11pm MST (UTC-7) (+10 points)</li>
<li>Original Due Date: April 27th 11pm MST (UTC-7) (+5 points)</li>
<li>Final Due Date: April 30th 11pm MST (UTC-7)</li>
</ul>
<h2 id="starting-point">
  Starting Point
  <a class="anchor" href="#starting-point">#</a>
</h2>
<p>The starter zip for this assignment contains the Web Application and Dockerfile needed to build the application image, as well as the CloudFormation template to be used to dpeloy the infrastrucutre resources.</p>
<blockquote class="book-hint info">
  <a href="https://www2.cs.arizona.edu/classes/cs346/spring24/homework/NETID-hw08.zip">https://www2.cs.arizona.edu/classes/cs346/spring24/homework/NETID-hw08.zip</a>
</blockquote>

<h2 id="part-0-update-s3-cloudformation-template-and-function-url">
  Part 0: Update S3 CloudFormation Template and Function URL
  <a class="anchor" href="#part-0-update-s3-cloudformation-template-and-function-url">#</a>
</h2>
<p>I had a mistake in the CloudFormation Template from Homework 7. In order to interact with the Upload S3 bucket with JavaScript in a web browser, CORS must be configured correctly on both buckets. I left off the CORS configuration from the Upload bucket in the homework 7 template.</p>
<p>There is an updated template in this assignment's starter ZIP, <code>s3_template_cors.yaml</code>.</p>
<h3 id="cloudformation-console">
  CloudFormation Console
  <a class="anchor" href="#cloudformation-console">#</a>
</h3>
<p>In your AWS console, navigate to the CloudFormation service. Locate the stack you created to deploy the two S3 buckets. Click on the resources tab to see that you have the correct stack.</p>
<p><img src="../hw08-cf-update-1.png" alt="A screenshot of the AWS CloudFormation console with the S3 Bucket stack selected" /></p>
<h3 id="update-s3-stack">
  Update S3 Stack
  <a class="anchor" href="#update-s3-stack">#</a>
</h3>
<p>With the stack selected, click on the &quot;Update&quot; button near the top. On the update screen, select &quot;Replace existing template&quot;. Then &quot;Upload a template file&quot;.  Click the &quot;Chose file&quot; button, and select the <code>s3_template_cors.yaml</code> file from the starter ZIP. Then click &quot;Next&quot;</p>
<p><img src="../hw08-cf-update-2.png" alt="A screenshot of the AWS CloudFormation console with the S3 Bucket stack selected" /></p>
<p>We don't need to change the stack name, parameters, or any other stack settings, so you can click &quot;Next&quot; through the Parameters screen and Configure stack options screen. When you get to the Review screen, scroll down and click &quot;Submit&quot;.</p>
<p>You can watch the progress on the &quot;Events&quot; tab. The update should only take 30 seconds or so.  Once the stack reaches &quot;UPDATE_COMPELTE&quot; you're done.</p>
<p><img src="../hw08-cf-update-3.png" alt="A screenshot of the AWS CloudFormation console showing a completed stack update event list" /></p>
<h3 id="lambda-function-url-cors-configuration">
  Lambda Function URL CORS Configuration
  <a class="anchor" href="#lambda-function-url-cors-configuration">#</a>
</h3>
<p>In homework 7, we only interacted with your lambda functions directly through Postman or <code>curl</code>. When trying to use the Function URL in JavaScript, modern browser enforce a security model called &quot;Cross-Origin Resource Sharing&quot; commonly abreviated as CORS.</p>
<blockquote class="book-hint info">
  <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS</a>
</blockquote>

<p>Navigate to the AWS Lambda console, and select your Generate Upload URL function. In the &quot;Configuration&quot; tab, select &quot;Function URL&quot; from the sidebar and click &quot;Edit&quot;.</p>
<p>Expand the &quot;Additional settings&quot; section, and check &quot;Configure cross-origin resource sharing (CORS)&quot;. You can leave everything in the CORS section as defaults except for the &quot;Allow methods&quot; section. You need to check GET for that. Then click the &quot;Save&quot; button and that should be it for updates.</p>
<p><img src="../hw08-cors.png" alt="A screenshot of a the Lambda Function URL setting screen" /></p>
<h2 id="part-1-upload-attached-images">
  Part 1: Upload Attached Images
  <a class="anchor" href="#part-1-upload-attached-images">#</a>
</h2>
<p>Here, you will tie in your image upload API system from homework 7. You will need to set your Function URL from your generate upload URL Lambda function as <code>generateApiFunctionUrl</code> at the top of <code>app.js</code>.</p>
<p>See the <code>PART 1</code> comments in <code>app.js</code> for more details on what code to complete.  There are sections to complete in the <code>checkUploadImage()</code> and <code>handleNewPost()</code> functions in <code>app.js</code>.</p>
<h2 id="part-2-update-chat-post-with-image-urls">
  Part 2: Update Chat POST with Image URLs
  <a class="anchor" href="#part-2-update-chat-post-with-image-urls">#</a>
</h2>
<p>After an image is uploaded to your S3 bucket, and they've been resized, you need to include the new fullsize and thumbnail image URLs with the <code>createPost</code> API call.  You will need to update the <code>handleNewPost()</code> function in <code>app.js</code> and the <code>createPost()</code> method in <code>picturegramSDK.js</code>.  See the STEP 2 comments in those files for details.</p>
<blockquote class="book-hint info">
  <p>As you test this part, I recommend un-commenting the debug line near the bottom of <code>picturegramSDK.js</code>. This will return an empty Promise object instead of actually calling the POST chat API, potentially saving you from uploading a bunch of chats with broken image URLs as you figure things out.</p>
<pre tabindex="0"><code>// return Promise.resolve({&#34;status&#34;: &#34;error&#34;, &#34;message&#34;: &#34;short circuit&#34;})
</code></pre><p>I also included a sample image you can use for testing if you don't want to hunt down your own.</p>

</blockquote>

<p>If all goes well, you should be able to include an image when you post a new chat message!</p>
<p><img src="../hw08-app-screenshot.png" alt="A screenshot of the chat app with some images posted" /></p>
<h2 id="part-3-elastic-container-registry">
  Part 3: Elastic Container Registry
  <a class="anchor" href="#part-3-elastic-container-registry">#</a>
</h2>
<p>We need to create an ECR repository to hold our build docker images. Since this is a pretty simple resource, it is easy to just create it manually in the AWS web console.</p>
<p>Log in to your AWS Academy account, start the lab, and access the AWS web console. Search for &quot;ECR&quot; and then click on the &quot;Create repository&quot; button. Leave all the settins as their default, and fill in the repository name.</p>
<p><img src="../hw08-ecr-1.png" alt="A screenshot of the Elastic Container Registry console" /></p>
<p>After creating the repository, click on the &quot;Show Push Commands&quot; button. You probably want to copy these to a notes file, or make a bash/powershell script to store that command to avoid having to come back here to get the login and push commands again.</p>
<blockquote class="book-hint info">
  <p>Find the <code>notes.txt</code> file from the starter ZIP and use it to record the various commands and values you'll need for this assignment:</p>
<ul>
<li>Docker Login Command:</li>
<li>Docker Build Command:</li>
<li>Docker Push Command:</li>
<li>Image URI:</li>
<li>TLS Cert ARN:</li>
<li>LabRole ARN:</li>
<li>VPC ID:</li>
<li>Subnet IDs:</li>
<li>LoadBalancerDNSName:</li>
</ul>

</blockquote>

<p><img src="../hw08-ecr-2.png" alt="A screenshot of the ECR push commands" /></p>
<p>Copy the Docker commands into <code>notes.txt</code>.</p>
<h2 id="part-4-build-and-push-your-docker-image">
  Part 4: Build and Push Your Docker Image
  <a class="anchor" href="#part-4-build-and-push-your-docker-image">#</a>
</h2>
<p>Before you can build and push your docker image, you must ensure that your AWS CLI credentials have been updated. Copy in the current values from the AWS Academy site into your <code>~/.aws/credentials</code> file.</p>
<blockquote class="book-hint warning">
  You will need to have the AWS CLI v2 tools installed to log in to the AWS ECR and push your Docker image up. See <a href="https://aws.amazon.com/cli/">https://aws.amazon.com/cli/</a> for instructions.
</blockquote>

<blockquote class="book-hint danger">
  <p>Apple Silicon Mac Users!</p>
<p>You will need to add an additional option to your <code>docker build</code> command to make sure you build for the correct architecture.</p>
<p>Add <code>--platform linux/amd64</code> before the <code>-t ...</code> option in the commands you copy from the ECR repository.  Somthing like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>docker build --platform linux/amd64 -t csc346-app .
</span></span></code></pre></div>
</blockquote>

<p>Once your image is uploaded, record the URI for your image in your Notes file.</p>
<p><img src="../hw08-ecr-3.png" alt="A screenshot of the ECR console with the URI for an image highlighted" /></p>
<h2 id="part-5-aws-certificate-manager">
  Part 5: AWS Certificate Manager
  <a class="anchor" href="#part-5-aws-certificate-manager">#</a>
</h2>
<p>Next, we need to upload a TLS (<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">transport layer security</a>) certificate for you to use on your Application Load Balancer to provide encryption for the application. Because we'll be using the <code>.arizona.edu</code> Domain Name, the certificate itslef needs to be issued by someone with the authority to issue certificats on the behalf of the University of Arizona. UITS does that for us fortunately!</p>
<p>In the services search bar of the AWS web console, search of &quot;ACM&quot; and go to the Certificate Manager console. From there click on the &quot;Import&quot; button to set up our certificate.</p>
<blockquote class="book-hint warning">
  If you see a big red &quot;Failed to list certificate authorities&quot; error, you clicked on the &quot;Request&quot; button. Go back and click on &quot;Import&quot;.
</blockquote>

<p>There are three text fields you need to fill with the contents of the certificates files from the starter kit:</p>
<ul>
<li>Certificate body: csc346_arizona_edu_cert.cer</li>
<li>Certificate private key: csc346_arizona_edu_cert.key</li>
<li>Certificate chain: csc346_arizona_edu_interm.cer</li>
</ul>
<p><img src="../hw08-acm-1.png" alt="A screenshot of the AWS Certificate Manager console" /></p>
<p>Copy the contents of each of the files into the associated text fields, then click the &quot;Next&quot; button. We don't need to add any tags to this, so click &quot;Next&quot; again, and then &quot;Import&quot; on the &quot;Review and import&quot; screen.</p>
<p>If you don't see your certificate right away, reload the page. Then click on your certificate to see the details, and copy the ARN to your Notes file.</p>
<p><img src="../hw08-acm-2.png" alt="A screenshot of the AWS Certificate Manager console" /></p>
<h2 id="part-6-gather-remaining-parameter-values">
  Part 6: Gather Remaining Parameter Values
  <a class="anchor" href="#part-6-gather-remaining-parameter-values">#</a>
</h2>
<p>The last bits of information you need to deploy the CloudFormation template are to find your Lab Role ARN, VPC ID, and Subnet IDs.</p>
<h3 id="lab-role-arn">
  Lab Role ARN
  <a class="anchor" href="#lab-role-arn">#</a>
</h3>
<p>Roles are located in the IAM service console, so find that from the services search bar, and then click on &quot;Roles&quot; in the left sidebar. Scroll down to find the &quot;LabRole&quot;, then click it to view the details. Copy the ARN of the role to your Notes file.</p>
<p><img src="../hw08-role.png" alt="A screenshot of the AWS IAM console for the LabRole with the ARN highlighted" /></p>
<h3 id="vpc-id">
  VPC ID
  <a class="anchor" href="#vpc-id">#</a>
</h3>
<p>To find the VPC ID for your account, search for the VPC service in the search bar. You should just have one default VPC. Copy its ID to your Notes file.</p>
<p><img src="../hw08-vpc.png" alt="A screenshot of the AWS VPC console" /></p>
<h3 id="vpc-subnet-ids">
  VPC Subnet IDs
  <a class="anchor" href="#vpc-subnet-ids">#</a>
</h3>
<p>Lastly we'll need two Subnet IDs to reference in our Application Load Balancer config.  From the VPC console, click on &quot;Subnets&quot; in the left sidebar.  We need two of these, but it doesn't matter which two. Copy their values to your Notes text file as a comma separated list.</p>
<p><img src="../hw08-subnets.png" alt="A screenshot of the AWS VPC console showing subnets" /></p>
<h2 id="part-7-cloudformation-deployment">
  Part 7: CloudFormation Deployment
  <a class="anchor" href="#part-7-cloudformation-deployment">#</a>
</h2>
<p>You should be ready to deploy the CloudFormation template now. Go to the CloudFormation console in AWS, and create a new stack with new resources.</p>
<p>Upload the <code>ecs_template.yaml</code> file from the starter ZIP, and fill in the Parameters from your Notes file.</p>
<p><img src="../hw08-cloudformation-1.png" alt="A screenshot of the AWS CloudFormation console" /></p>
<p>Click through &quot;Next&quot; and &quot;Next&quot; and finally &quot;Submit&quot; the template.  Once the stack completes, click on the &quot;Outputs&quot; tab to see the DNS name for the Application Load Balancer. Copy this to your Notes file as well, you will need that to put in on the automated testing app to connect the DNS.</p>
<p><img src="../hw08-cloudformation-2.png" alt="A screenshot of the AWS CloudFormation console" /></p>
<p>If you click on the DNS name value, it will attempt to open that in a new browser tab. However you will see some sort of certificate error depending on your browser. Recall that the TLS certificate we assigned to the ALB is only valid for <code>*.csc346.arizona.edu</code>, and that's not the current name of the ALB. We need to add an additional DNS CNAME record to point <code>yournetid.csc346.arizona.edu</code> at the value for your ALB's existing DNS entry.</p>
<h2 id="part-8-re-deploy-your-ecs-service">
  Part 8: Re-Deploy Your ECS Service
  <a class="anchor" href="#part-8-re-deploy-your-ecs-service">#</a>
</h2>
<p>If you change your code, you need to build and push the new Docker image to your ECR repository. You can then trigger a service re-deployment to get your updated application image in to use.</p>
<p>Log in to the AWS Console, and go to the ECS console.  Then find the ECS Cluster for your app.  Click on the cluster name to view the details.</p>
<p>From the Cluster details page, click on the name of the Service for your chat app to look at its details.</p>
<p>Click on Update Service</p>
<p><img src="../hw08-service-update-1.png" alt="A screenshot of the chat app with some images posted" /></p>
<p>Check the &quot;Force new deployment&quot; checkbox.</p>
<p><img src="../hw08-service-update-2.png" alt="A screenshot of the chat app with some images posted" /></p>
<p>Scroll to the bottom of that page and click &quot;Update&quot;. From there you can return to the Service tab, click on your service, and then monitor the Events tab to see the new container get deployed, and the service reach a new steady state.  From there you should be able to test your newly deployed app at <a href="https://yournetid.csc346.arizona.edu/">https://yournetid.csc346.arizona.edu/</a> and then submit it for automated testing.</p>
<h2 id="part-9-automated-testing">
  Part 9: Automated Testing
  <a class="anchor" href="#part-9-automated-testing">#</a>
</h2>
<p>The testing website has been updated for Homework 8.</p>
<blockquote class="book-hint info">
  <a href="https://csc346.test.apps.uits.arizona.edu">https://csc346.test.apps.uits.arizona.edu</a>
</blockquote>

<p>Once you have deployed your CloudFormation stack, go to the Outputs tab on the deployed stack, and copy the DNS name of your Application Load Balancer. It should look something like <code>csc34-LoadB-1P83SOIQSA2SJ-1369304737.us-east-1.elb.amazonaws.com</code>. The first time you visit the testing site, you will need to put in your ALB DNS name into the field to set it and run the tests. This will create a DNS CNAME entry for <code>yournetid.csc346.arizona.edu</code> to your ALB. If you run in to a <code>net::ERR_NAME_NOT_RESOLVED</code>, go back and try running tests again. Sometimes the DNS records take a minute to be fully resolve.</p>
<p>Once you've set your DNS record, you don't need to keep putting in a value to the DNS record field. You can just test your saved record.</p>
<h2 id="troubleshooting">
  Troubleshooting
  <a class="anchor" href="#troubleshooting">#</a>
</h2>
<p>As errors are reported to me, I will update this section with additional troubleshooting ideas.</p>
<h3 id="cloudformation-stack-deployment-errors">
  CloudFormation Stack Deployment Errors
  <a class="anchor" href="#cloudformation-stack-deployment-errors">#</a>
</h3>
<p>If you have problems deploying the S3 CloudFormation stacks, double check that the URL is correct when specifying the S3 template URL. Also check the Events tab of the stack to see what errors show up there. Bring errors to the Discord class channel and we'll work through them.</p>
<h3 id="failed-test-results">
  FAILED Test Results
  <a class="anchor" href="#failed-test-results">#</a>
</h3>
<h4 id="neterr_name_not_resolved">
  <code>net::ERR_NAME_NOT_RESOLVED</code>
  <a class="anchor" href="#neterr_name_not_resolved">#</a>
</h4>
<p>If you hit this error which will cause all your tests to fail, go back and reload the page and try running tests again in a few minutes. Sometimes it can take up to 5 minutes to fully propogate the new DNS records everywhere.</p>
<h3 id="docker-issues">
  Docker Issues
  <a class="anchor" href="#docker-issues">#</a>
</h3>
<p><code>Error saving credentials: error storing credentials - err: exit status 1, out: 'Post &quot;http://ipc/registry/credstore-updated&quot;: dial unix backend.sock: connect: no such file or directory'</code></p>
<p>Docker is not running on your local computer. Start up Docker Desktop first and try again.</p>
<h3 id="cors-issue">
  CORS Issue
  <a class="anchor" href="#cors-issue">#</a>
</h3>
<p><code>origin has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource.</code></p>
<p>You are probably just loading your <code>index.html</code> file directly in the browser. Check the URL field in your browser. If it starts with <code>file:///...</code> then you're doing this.  For AJAX/Fetch calls to work, the page must be loaded from a web server.  Run your app's docker container, and access your app via <code>http://localhost:8080/</code> instead.</p>
<p>You also may have not updated the Upload S3 bucket. See Step 0 above.</p>
<p>Alternatively, if you are accessing it through a web server, either at http://localhost:8080 or at <a href="https://yournetid.csc346.arizona.edu">https://yournetid.csc346.arizona.edu</a> and you're still seeing the CORS error, and you're running in to this error when trying the <code>fetch()</code> call to generate the signed upload URL, it might be the Function URL settings. In your generate upload URL Lambda function, check the Function URL configuration, and make sure that CORS is checked, and that the Allow origin field has an asterisk in it: <code>*</code>.</p>
<p><img src="../hw08-cors.png" alt="A screenshot of a the Lambda Function URL setting screen" /></p>
<h3 id="503-service-unavailable">
  503 Service Unavailable
  <a class="anchor" href="#503-service-unavailable">#</a>
</h3>
<p>If your CloudFormation stack seems to hang on deploying the &quot;Service&quot;, it may be that your ECS Service never reaches a steady state. The ALB doesn't have a healthy backend host, and so displays the 503 Service Unavailable error message.  You can check this by navigating to the Elastic Container Service, clicking on your Cluster, and then clicking on the service link in the Services section. Then go to the &quot;Events&quot; tab.  If you see a long series of register target, deregister target, draining target etc, you're likely in this situation.</p>
<p>Check the &quot;Logs&quot; tab, and see if you have a bunch of errors like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>exec /docker-entrypoint.sh: exec format error
</span></span></code></pre></div><p>If you do, you have an incompatible Docker image architecture. So far we've only see this for users who have the newer Apple Silicon Mac computers. In that case you need to add an additional option to your docker build command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>docker build --platform linux/amd64 -t csc346-chat-app .
</span></span></code></pre></div><p>Once you rebuild your image, you will need to re-tag it and re-upload it to your ECR. You should not have to delete or re-deploy the CloudFormation stack. Just wait 5-10 minutes and hopefully your image should load.</p>
<h3 id="javascript-files-never-update">
  JavaScript Files Never Update
  <a class="anchor" href="#javascript-files-never-update">#</a>
</h3>
<p>Your browser will agressivly cache javascript files from 'real' websites, and now your app is pretty much a real website. You will need to either clear your browser's cache files for that page, or hold down the Shift key on your keyboard when clicking the Reload button. That should force the browser to download fresh copies of your JavaScript files from the server.</p>
<p>See the <a href="http://portfolio.fischco.org/csc346/docs/homework/hw07/">Troubleshooting section from Homework 3</a> for more ways to deal with browser cacheing.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#what-to-turn-in">What to turn in</a></li>
    <li><a href="#points">Points</a></li>
    <li><a href="#starting-point">Starting Point</a></li>
    <li><a href="#part-0-update-s3-cloudformation-template-and-function-url">Part 0: Update S3 CloudFormation Template and Function URL</a>
      <ul>
        <li><a href="#cloudformation-console">CloudFormation Console</a></li>
        <li><a href="#update-s3-stack">Update S3 Stack</a></li>
        <li><a href="#lambda-function-url-cors-configuration">Lambda Function URL CORS Configuration</a></li>
      </ul>
    </li>
    <li><a href="#part-1-upload-attached-images">Part 1: Upload Attached Images</a></li>
    <li><a href="#part-2-update-chat-post-with-image-urls">Part 2: Update Chat POST with Image URLs</a></li>
    <li><a href="#part-3-elastic-container-registry">Part 3: Elastic Container Registry</a></li>
    <li><a href="#part-4-build-and-push-your-docker-image">Part 4: Build and Push Your Docker Image</a></li>
    <li><a href="#part-5-aws-certificate-manager">Part 5: AWS Certificate Manager</a></li>
    <li><a href="#part-6-gather-remaining-parameter-values">Part 6: Gather Remaining Parameter Values</a>
      <ul>
        <li><a href="#lab-role-arn">Lab Role ARN</a></li>
        <li><a href="#vpc-id">VPC ID</a></li>
        <li><a href="#vpc-subnet-ids">VPC Subnet IDs</a></li>
      </ul>
    </li>
    <li><a href="#part-7-cloudformation-deployment">Part 7: CloudFormation Deployment</a></li>
    <li><a href="#part-8-re-deploy-your-ecs-service">Part 8: Re-Deploy Your ECS Service</a></li>
    <li><a href="#part-9-automated-testing">Part 9: Automated Testing</a></li>
    <li><a href="#troubleshooting">Troubleshooting</a>
      <ul>
        <li><a href="#cloudformation-stack-deployment-errors">CloudFormation Stack Deployment Errors</a></li>
        <li><a href="#failed-test-results">FAILED Test Results</a></li>
        <li><a href="#docker-issues">Docker Issues</a></li>
        <li><a href="#cors-issue">CORS Issue</a></li>
        <li><a href="#503-service-unavailable">503 Service Unavailable</a></li>
        <li><a href="#javascript-files-never-update">JavaScript Files Never Update</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












